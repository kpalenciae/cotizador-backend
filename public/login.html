<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Acceso al Sistema</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color:#f5f7fb; }
    .login-wrapper { min-height:100vh; display:flex; align-items:center; justify-content:center; }
    .card-login { max-width:420px; width:100%; border:0; border-radius:1rem; }
    .nav-pills .nav-link { border-radius:.5rem; }
    .form-control { border-radius:.6rem; }
    .btn-green { background:#1f9d62; border-color:#1f9d62; }
    .btn-green:hover { background:#168a54; border-color:#168a54; }
    .brand-muted { color:#6c757d; font-size:.9rem; }
    .footer-muted { font-size:.8rem; color:#98a2b3; }
  </style>
</head>
<body>
  <div class="login-wrapper container">
    <div class="card shadow-sm card-login">
      <div class="card-body p-4">
        <h4 class="text-center mb-1">Acceso al Sistema</h4>
        <p class="text-center text-muted mb-4">Ingrese sus credenciales para acceder</p>

        <!-- Tabs (solo visual) -->
        <ul class="nav nav-pills mb-4 justify-content-center" id="pills-tab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pills-login-tab" data-bs-toggle="pill" data-bs-target="#pills-login" type="button" role="tab">Iniciar Sesión</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="pills-help-tab" data-bs-toggle="pill" data-bs-target="#pills-help" type="button" role="tab">Ayuda</button>
          </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
          <!-- TAB LOGIN -->
          <div class="tab-pane fade show active" id="pills-login" role="tabpanel">
            <form id="formLogin" class="needs-validation" novalidate>
              <div class="mb-3">
                <label class="form-label">Correo Electrónico</label>
                <input type="email" class="form-control" id="correo" placeholder="correo@dominio.com" required>
                <div class="invalid-feedback">Ingrese un correo válido.</div>
              </div>

              <div class="mb-1">
                <div class="input-group">
                  <input type="password" class="form-control" id="password" placeholder="••••••••" required minlength="4" autocomplete="current-password">
                  <button class="btn btn-outline-secondary" type="button" id="togglePwd" title="Mostrar/Ocultar">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
                <div class="invalid-feedback">Ingrese su contraseña.</div>
              </div>

              <div class="d-grid mt-4">
                <button type="submit" class="btn btn-green btn-lg" id="btnIngresar">
                  Ingresar
                </button>
              </div>
            </form>

            <div id="alerta" class="alert alert-danger d-none mt-3" role="alert"></div>
          </div>

          <!-- TAB AYUDA -->
          <div class="tab-pane fade" id="pills-help" role="tabpanel">
            <div class="brand-muted">
              Si tiene problemas para ingresar, contacte a soporte o verifique sus credenciales.
            </div>
          </div>
        </div>

        <div class="text-center mt-4 footer-muted">© 2025 FarmaMed. Todos los derechos reservados.</div>
      </div>
    </div>
  </div>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ====== Config ======
    const LOGIN_ENDPOINT = '/api/usuarios/login'; // nuevo controller: espera {correo, password}
    const DASHBOARD_URL = '/dashboard.html';          // cambia si tu inicio es otro

    // Si ya hay sesión, redirige
    (function autoRedirectIfLogged() {
      try {
        const token = localStorage.getItem('token');
        const usuario = JSON.parse(localStorage.getItem('usuario') || 'null');
        if (token && usuario && usuario.id) {
          window.location.href = DASHBOARD_URL;
        }
      } catch (_) {}
    })();

    // Helpers UI
    function setLoading(loading) {
      const btn = document.getElementById('btnIngresar');
      btn.disabled = loading;
      btn.innerHTML = loading ? '<span class="spinner-border spinner-border-sm me-2"></span>Validando…' : 'Ingresar';
    }
    function showError(msg) {
      const a = document.getElementById('alerta');
      a.textContent = msg;
      a.classList.remove('d-none');
    }
    function hideError() {
      document.getElementById('alerta').classList.add('d-none');
    }

    // Mostrar/Ocultar contraseña
    document.getElementById('togglePwd').addEventListener('click', () => {
      const input = document.getElementById('password');
      const isPwd = input.type === 'password';
      input.type = isPwd ? 'text' : 'password';
      document.getElementById('togglePwd').innerHTML = isPwd ? '<i class="bi bi-eye-slash"></i>' : '<i class="bi bi-eye"></i>';
    });

    // ====== Validación + Submit ======
    (function () {
      const form = document.getElementById('formLogin');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideError();

        if (!form.checkValidity()) {
          form.classList.add('was-validated');
          return;
        }

        const correo = document.getElementById('correo').value.trim();
        const password = document.getElementById('password').value;

        setLoading(true);
        try {
          const res = await fetch(LOGIN_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ correo, password })
          });

          // Intenta parsear respuesta
          let payload = null;
          try { payload = await res.json(); } catch (_) { payload = null; }

          if (!res.ok) {
            const msg = (payload && (payload.message || payload.error)) || 'No fue posible iniciar sesión.';
            showError(msg);
            return;
          }

          // Esperado: { token, usuario: { id, nombre, correo, rol_id, ... } }
          if (!payload || !payload.token || !payload.usuario) {
            showError('La respuesta del servidor no es válida.');
            return;
          }

          // Guardar sesión
          localStorage.setItem('token', payload.token);
          localStorage.setItem('usuario', JSON.stringify(payload.usuario));

          // Redirigir
          window.location.href = DASHBOARD_URL;
        } catch (err) {
          showError('Error de red: verifique su conexión o contacte a soporte.');
        } finally {
          setLoading(false);
        }
      });
    })();
  </script>
</body>
</html>
