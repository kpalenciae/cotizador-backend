<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FarmaMed · Cotizaciones</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    body{background:#f6f8fb}
    .page{max-width:1200px}
    .badge-soft{background:#f4f6fb;color:#274b69;border:1px solid #dfe7f3;font-weight:600}
    .table > :not(caption) > * > *{background:transparent}
    .toolbar{position:sticky;top:0;z-index:10;background:#f6f8fb;padding-top:1rem}
  </style>
</head>
<body>
  <main class="container page py-3">
    <div class="toolbar pb-2 mb-3 border-bottom">
      <div class="d-flex justify-content-between align-items-center gap-2">
        <h2 class="mb-0">Cotizaciones</h2>
        <div class="d-flex gap-2">
          <a class="btn btn-outline-secondary" href="dashboard.html">
            <i class="bi bi-arrow-left-circle"></i> Volver al Dashboard
          </a>
        </div>
      </div>

      <div class="row g-2 mt-3">
        <div class="col-12 col-md-4">
          <div class="input-group">
            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
            <input id="q" class="form-control" placeholder="Buscar cliente/negocio...">
          </div>
        </div>
        <div class="col-6 col-md-3">
          <select id="estado" class="form-select">
            <option value="">Todos los estados</option>
            <option value="Pendiente">Pendiente</option>
            <option value="Enviada">Enviada</option>
            <option value="Completada">Completada</option>
          </select>
        </div>
        <div class="col-6 col-md-3">
          <input id="fecha" type="date" class="form-control"/>
        </div>
        <div class="col-12 col-md-2 d-grid">
          <button id="btnFiltrar" class="btn btn-success"><i class="bi bi-funnel"></i> Filtrar</button>
        </div>
      </div>
    </div>

    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="text-muted small">
            <span id="lblTotal">0</span> cotización(es)
          </div>
          <div class="d-flex align-items-center gap-2">
            <label class="text-muted small">Por página</label>
            <select id="pageSize" class="form-select form-select-sm" style="width:90px">
              <option>5</option><option selected>10</option><option>20</option>
            </select>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table align-middle">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>Fecha</th>
                <th>Estado</th>
                <th class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <nav class="mt-2">
          <ul id="pager" class="pagination pagination-sm mb-0 justify-content-end"></ul>
        </nav>
      </div>
    </div>
  </main>

  <!-- Modal Detalle -->
  <div class="modal fade" id="modalDetalle" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width:760px">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">Detalle de Cotización</h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <div class="small text-muted">ID</div>
            <div class="fw-semibold" id="detId">—</div>
          </div>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th>Producto</th>
                  <th>Código</th>
                  <th class="text-center">Cantidad</th>
                  <th>Notas</th>
                </tr>
              </thead>
              <tbody id="tbodyDetalle"></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-dark" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Completar -->
  <div class="modal fade" id="modalCompletar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">Completar cotización</h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          ¿Confirmas marcar la cotización <strong id="cxId">—</strong> como <span class="text-success">Completada</span>?
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button id="btnConfirmCompletar" class="btn btn-success">
            <i class="bi bi-check2-circle"></i> Completar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const tbody   = document.getElementById('tbody');
    const pager   = document.getElementById('pager');
    const lblTot  = document.getElementById('lblTotal');
    const modalDet= new bootstrap.Modal(document.getElementById('modalDetalle'));
    const modalCx = new bootstrap.Modal(document.getElementById('modalCompletar'));

    let page=1, pageSize=10, total=0, rows=[];
    let idACompletar = null;

    const estadoBadge = (estado) => {
      const map = { 'Pendiente':'warning', 'Enviada':'primary', 'Completada':'success' };
      const color = map[estado] || 'secondary';
      return `<span class="badge text-bg-${color}">${estado}</span>`;
    };

    async function cargar(){
      const params = new URLSearchParams({
        page, pageSize,
        q: document.getElementById('q').value.trim(),
        estado: document.getElementById('estado').value,
        fecha: document.getElementById('fecha').value
      }).toString();

      const r = await fetch(`/api/cotizaciones3?${params}`);
      const json = await r.json();
      rows  = json.data || [];
      total = json.total || 0;

      lblTot.textContent = total;
      renderTabla();
      renderPager();
    }

    function renderTabla(){
      tbody.innerHTML = rows.map(c => `
        <tr>
          <td>${c.id_fmt}</td>
          <td>${c.cliente}</td>
          <td>${(c.fecha||'').slice(0,10)}</td>
          <td>${estadoBadge(c.estado)}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-secondary me-1" data-view="${c.id}">
              <i class="bi bi-eye"></i> Ver
            </button>
            ${c.estado==='Completada' ? '' : `
              <button class="btn btn-sm btn-success" data-done="${c.id}" data-idfmt="${c.id_fmt}">
                <i class="bi bi-check2-circle"></i> Completar
              </button>`}
          </td>
        </tr>
      `).join('');

      // wire acciones
      tbody.querySelectorAll('[data-view]').forEach(b => {
        b.addEventListener('click', async e => {
          const id = e.currentTarget.dataset.view;
          document.getElementById('detId').textContent = `COT-${String(id).padStart(3,'0')}`;
          const r = await fetch(`/api/cotizaciones3/${id}/detalles`);
          const det = await r.json();
          document.getElementById('tbodyDetalle').innerHTML = det.map(d => `
            <tr>
              <td>${d.producto}</td>
              <td>${d.codigo}</td>
              <td class="text-center">${d.cantidad}</td>
              <td>${d.notas || ''}</td>
            </tr>
          `).join('');
          modalDet.show();
        });
      });

      tbody.querySelectorAll('[data-done]').forEach(b => {
        b.addEventListener('click', e => {
          idACompletar = Number(e.currentTarget.dataset.done);
          document.getElementById('cxId').textContent = e.currentTarget.dataset.idfmt;
          modalCx.show();
        });
      });
    }

    document.getElementById('btnConfirmCompletar').addEventListener('click', async ()=>{
      if (!idACompletar) return;
      const r = await fetch(`/api/cotizaciones3/${idACompletar}/estado`, {
        method:'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ estado: 'Completada' })
      });
      if (r.ok){
        modalCx.hide();
        await cargar();
      } else {
        alert('No fue posible completar la cotización');
      }
    });

    function renderPager(){
      const pages = Math.max(1, Math.ceil(total / pageSize));
      let html = `
        <li class="page-item ${page<=1?'disabled':''}">
          <a class="page-link" href="#" data-p="${page-1}">«</a>
        </li>`;
      for (let i=1;i<=pages;i++){
        if (i>1 && i<pages && (i>3 && i<page-1 || i>page+1 && i<pages-2)) {
          if (!html.endsWith('…</li>')) html += `<li class="page-item disabled"><span class="page-link">…</span></li>`;
          continue;
        }
        html += `<li class="page-item ${i===page?'active':''}">
          <a class="page-link" href="#" data-p="${i}">${i}</a></li>`;
      }
      html += `
        <li class="page-item ${page>=pages?'disabled':''}">
          <a class="page-link" href="#" data-p="${page+1}">»</a>
        </li>`;
      pager.innerHTML = html;
      pager.querySelectorAll('[data-p]').forEach(a=>{
        a.addEventListener('click', e=>{
          e.preventDefault();
          const p = Number(e.currentTarget.dataset.p);
          if (p && p!==page){ page=p; cargar(); }
        });
      });
    }

    // filtros
    document.getElementById('btnFiltrar').addEventListener('click', ()=>{ page=1; pageSize=Number(document.getElementById('pageSize').value); cargar(); });
    document.getElementById('pageSize').addEventListener('change', ()=>{ page=1; pageSize=Number(document.getElementById('pageSize').value); cargar(); });
    document.getElementById('q').addEventListener('keydown', e=>{ if(e.key==='Enter'){ page=1; cargar(); } });

    cargar();
  </script>
</body>
</html>
